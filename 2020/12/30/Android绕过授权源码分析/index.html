<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android," />




  


  <link rel="alternate" href="/atom.xml" title="clicker's blogs" type="application/atom+xml" />






<meta name="description" content="*郑重声明：本文内容只为学习研究之用，如有人用于非法用途，产生的后果笔者不负任何责任。 设备：root过的Android7.1 在上篇文章中我们跟着沿着源码追溯了Android系统授权的过程，这篇文章记录下怎么绕过系统的校验。 可以看到检查权限时的一个分支为： 1234&#x2F;&#x2F; Root, system server get to do everything.        if (uid &#x3D;&#x3D; 0">
<meta property="og:type" content="article">
<meta property="og:title" content="Android绕过授权方法实践">
<meta property="og:url" content="http://yoursite.com/2020/12/30/Android%E7%BB%95%E8%BF%87%E6%8E%88%E6%9D%83%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="clicker&#39;s blogs">
<meta property="og:description" content="*郑重声明：本文内容只为学习研究之用，如有人用于非法用途，产生的后果笔者不负任何责任。 设备：root过的Android7.1 在上篇文章中我们跟着沿着源码追溯了Android系统授权的过程，这篇文章记录下怎么绕过系统的校验。 可以看到检查权限时的一个分支为： 1234&#x2F;&#x2F; Root, system server get to do everything.        if (uid &#x3D;&#x3D; 0">
<meta property="og:image" content="http://yoursite.com/2020/12/30/Android%E7%BB%95%E8%BF%87%E6%8E%88%E6%9D%83%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/10C8C19E-B352-4eb6-9CA1-F7FCFD6A734F.png">
<meta property="og:image" content="http://yoursite.com/2020/12/30/Android%E7%BB%95%E8%BF%87%E6%8E%88%E6%9D%83%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/E21AE1A6-64E0-40d1-A43A-12E6A6EC9543.png">
<meta property="article:published_time" content="2020-12-30T02:04:55.000Z">
<meta property="article:modified_time" content="2020-12-31T09:48:56.497Z">
<meta property="article:author" content="clicker">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/12/30/Android%E7%BB%95%E8%BF%87%E6%8E%88%E6%9D%83%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/10C8C19E-B352-4eb6-9CA1-F7FCFD6A734F.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/12/30/Android绕过授权源码分析/"/>





  <title>Android绕过授权方法实践 | clicker's blogs</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">clicker's blogs</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/30/Android%E7%BB%95%E8%BF%87%E6%8E%88%E6%9D%83%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="clicker">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="clicker's blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android绕过授权方法实践</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-30T10:04:55+08:00">
                2020-12-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" itemprop="url" rel="index">
                    <span itemprop="name">Android源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>*郑重声明：本文内容只为学习研究之用，如有人用于非法用途，产生的后果笔者不负任何责任。</strong></p>
<p><em>设备</em>：<strong>root</strong>过的Android7.1</p>
<p>在<a href="https://sleepydogyp.github.io/2020/12/21/Android%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#more" target="_blank" rel="noopener">上篇文章</a>中我们跟着沿着源码追溯了Android系统授权的过程，这篇文章记录下怎么绕过系统的校验。</p>
<p>可以看到检查权限时的一个分支为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Root, system server get to do everything.</span></span><br><span class="line">        <span class="keyword">if</span> (uid == <span class="number">0</span> || uid == Process.SYSTEM_UID) &#123;</span><br><span class="line">            <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，我们只需要将自己的app的uid伪装成0或者1000即可绕过授权，直接返回<code>PackageManager.PERMISSION_GRANTED</code>.</p>
<p>在Android 8之前，uid判断在<code>ActivityManager.checkComponentPermission</code>中。从Android 8开始，这段代码前置到了ContextImpl.java中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1659</span>    <span class="meta">@Override</span></span><br><span class="line"><span class="number">1660</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line"><span class="number">1661</span>        <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1662</span>            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"permission is null"</span>);</span><br><span class="line"><span class="number">1663</span>        &#125;</span><br><span class="line"><span class="number">1664</span></span><br><span class="line"><span class="number">1665</span>        <span class="keyword">final</span> IActivityManager am = ActivityManager.getService();</span><br><span class="line"><span class="number">1666</span>        <span class="keyword">if</span> (am == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1667</span>            <span class="comment">// Well this is super awkward; we somehow don't have an active</span></span><br><span class="line"><span class="number">1668</span>            <span class="comment">// ActivityManager instance. If we're testing a root or system</span></span><br><span class="line"><span class="number">1669</span>            <span class="comment">// UID, then they totally have whatever permission this is.</span></span><br><span class="line"><span class="number">1670</span>            <span class="keyword">final</span> <span class="keyword">int</span> appId = UserHandle.getAppId(uid);</span><br><span class="line"><span class="number">1671</span>            <span class="keyword">if</span> (appId == Process.ROOT_UID || appId == Process.SYSTEM_UID) &#123;</span><br><span class="line"><span class="number">1672</span>                Slog.w(TAG, <span class="string">"Missing ActivityManager; assuming "</span> + uid + <span class="string">" holds "</span> + permission);</span><br><span class="line"><span class="number">1673</span>                <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line"><span class="number">1674</span>            &#125;</span><br><span class="line"><span class="number">1675</span>        &#125;</span><br><span class="line"><span class="number">1676</span></span><br><span class="line"><span class="number">1677</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">1678</span>            <span class="keyword">return</span> am.checkPermission(permission, pid, uid);</span><br><span class="line"><span class="number">1679</span>        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"><span class="number">1680</span>            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line"><span class="number">1681</span>        &#125;</span><br><span class="line"><span class="number">1682</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>我们以新版本为例进行绕过实践。</p>
<h4 id="修改uid之getuid"><a href="#修改uid之getuid" class="headerlink" title="修改uid之getuid"></a>修改uid之getuid</h4><p>一开始我的思路是，既然设备已经root了，直接执行<code>su</code>不就好了。实践证明不可行。</p>
<blockquote>
<p>Runtime.exec(“su”)后 只是这个返回Process类的输出流其写入的命令行参数执行的环境才是uid=0的进程环境, 在此之外, 整个app 的uid并不是0, 而是不变。</p>
</blockquote>
<p>那么，考虑利用<code>su</code>直接修改记录了uid的<code>/data/system.packages.list</code>,把对应的uid改为0。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">        Process process = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            process = Runtime.getRuntime().exec(<span class="string">"su"</span>);</span><br><span class="line">            DataOutputStream dataOutputStream = <span class="keyword">new</span> DataOutputStream(process.getOutputStream());</span><br><span class="line">            dataOutputStream.writeBytes(<span class="string">"chmod 777 /data/system/packages.list \n"</span>);</span><br><span class="line">            dataOutputStream.writeBytes(<span class="string">"sed -i '/package.name/d' /data/system/packages.list \n"</span>);</span><br><span class="line">            dataOutputStream.writeBytes(<span class="string">"sed -i '$a package.name 0 1 /data/user/0/com.android.sparrow default 3003'  /data/system/packages.list"</span>);</span><br><span class="line"><span class="comment">//            dataOutputStream.writeBytes("reboot \n");</span></span><br><span class="line"></span><br><span class="line">            dataOutputStream.flush();</span><br><span class="line">            dataOutputStream.close();</span><br><span class="line">            process.waitFor();</span><br><span class="line">            process.destroy();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>执行成功！</p>
<p><img src="10C8C19E-B352-4eb6-9CA1-F7FCFD6A734F.png" alt=""></p>
<p><img src="E21AE1A6-64E0-40d1-A43A-12E6A6EC9543.png" alt=""></p>
<p>但是app读取的uid依然没变，说明判断权限时的UID不是从这个文件读取的。</p>
<p><code>ActivityCompat.checkSelfPermission()</code>中的调用语句：<code>context.checkPermission(permission, android.os.Process.myPid(), Process.myUid())</code></p>
<p>可以看出uid是由<code>Process.myUid()</code>返回的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">myUid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Os.getuid();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Os:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * See &lt;a href="http://man7.org/linux/man-pages/man2/getuid.2.html"&gt;getuid(2)&lt;/a&gt;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getuid</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Libcore.os.getuid(); &#125;</span><br></pre></td></tr></table></figure>

<p>Libcore类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span><span class="keyword">package</span> libcore.io;</span><br><span class="line"><span class="number">18</span></span><br><span class="line"><span class="number">19</span><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Libcore</span> </span>&#123;</span><br><span class="line"><span class="number">20</span>    <span class="function"><span class="keyword">private</span> <span class="title">Libcore</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="number">22</span>    <span class="keyword">public</span> <span class="keyword">static</span> Os os = <span class="keyword">new</span> BlockGuardOs(<span class="keyword">new</span> Posix());</span><br><span class="line"><span class="number">23</span>&#125;</span><br></pre></td></tr></table></figure>

<p>可知调用了BlockGuardOs对象的getUid()方法，实现在其父类ForwardingOs：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getuid</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> os.getuid(); &#125;</span><br></pre></td></tr></table></figure>

<p>这里的os即为传入的Posix对象，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> 	  <span class="keyword">protected</span> <span class="keyword">final</span> Os os;</span><br><span class="line"><span class="number">48</span></span><br><span class="line"><span class="number">49</span>    <span class="function"><span class="keyword">public</span> <span class="title">ForwardingOs</span><span class="params">(Os os)</span> </span>&#123;</span><br><span class="line"><span class="number">50</span>        <span class="keyword">this</span>.os = os;</span><br><span class="line"><span class="number">51</span>    &#125;</span><br><span class="line"><span class="number">98</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getuid</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> os.getuid(); &#125;</span><br></pre></td></tr></table></figure>

<p>Posix中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">getuid</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>调用了Native方法。</p>
<p><a href="http://androidxref.com/6.0.1_r10/xref/libcore/luni/src/main/native/libcore_io_Posix.cpp" target="_blank" rel="noopener">http://androidxref.com/6.0.1_r10/xref/libcore/luni/src/main/native/libcore_io_Posix.cpp</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	<span class="function"><span class="keyword">static</span> jint <span class="title">Posix_getuid</span><span class="params">(JNIEnv*, jobject)</span> </span>&#123;</span><br><span class="line"><span class="number">1062</span>    <span class="keyword">return</span> getuid();</span><br><span class="line"><span class="number">1063</span>&#125;</span><br></pre></td></tr></table></figure>

<p>到这里，本该去看getuid()的实现，但是到这里就断了，没有找到。</p>
<p>没办法，只能回头看看uid是怎么产生的，看能不能在生成uid时动动手脚。</p>
<h4 id="修改uid之生成uid"><a href="#修改uid之生成uid" class="headerlink" title="修改uid之生成uid"></a>修改uid之生成uid</h4><p>uid是应用安装时被分配的，具体过程的源码分析网上比较多，这里不具体说了。</p>
<p>涉及到的关键类<code>PackageManagerService</code>，它负责解析AndroidManifest.xml，从中得到应用程序相关信息。</p>
<p><a href="http://androidxref.com/6.0.1_r10/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java" target="_blank" rel="noopener">http://androidxref.com/6.0.1_r10/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</a></p>
<p>从<code>PackageManagerService.main()</code>入手，它负责把PackageManagerService启动起来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageManagerService <span class="title">main</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">1766</span>            <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line"><span class="number">1767</span>        PackageManagerService m = <span class="keyword">new</span> PackageManagerService(context, installer,</span><br><span class="line"><span class="number">1768</span>                factoryTest, onlyCore);</span><br><span class="line"><span class="number">1769</span>        ServiceManager.addService(<span class="string">"package"</span>, m);</span><br><span class="line"><span class="number">1770</span>        <span class="keyword">return</span> m;</span><br><span class="line"><span class="number">1771</span>    &#125;</span><br></pre></td></tr></table></figure>

<p><code>PackageManagerService</code>的构造方法是一个六百多行的方法，接下来我们详细分析。</p>
<p>首先，初始化一些保存各种信息的数据结构，其中比较关键的是<code>Settings</code>对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">			......</span><br><span class="line">			mSettings = <span class="keyword">new</span> Settings(mPackages);</span><br><span class="line"><span class="number">1816</span>        mSettings.addSharedUserLPw(<span class="string">"android.uid.system"</span>, Process.SYSTEM_UID,</span><br><span class="line"><span class="number">1817</span>                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"><span class="number">1818</span>        mSettings.addSharedUserLPw(<span class="string">"android.uid.phone"</span>, RADIO_UID,</span><br><span class="line"><span class="number">1819</span>                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"><span class="number">1820</span>        mSettings.addSharedUserLPw(<span class="string">"android.uid.log"</span>, LOG_UID,</span><br><span class="line"><span class="number">1821</span>                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"><span class="number">1822</span>        mSettings.addSharedUserLPw(<span class="string">"android.uid.nfc"</span>, NFC_UID,</span><br><span class="line"><span class="number">1823</span>                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"><span class="number">1824</span>        mSettings.addSharedUserLPw(<span class="string">"android.uid.bluetooth"</span>, BLUETOOTH_UID,</span><br><span class="line"><span class="number">1825</span>                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"><span class="number">1826</span>        mSettings.addSharedUserLPw(<span class="string">"android.uid.shell"</span>, SHELL_UID,</span><br><span class="line"><span class="number">1827</span>                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">			......</span><br></pre></td></tr></table></figure>

<p><a href="http://androidxref.com/8.1.0_r33/xref/frameworks/base/services/core/java/com/android/server/pm/Settings.java" target="_blank" rel="noopener">http://androidxref.com/8.1.0_r33/xref/frameworks/base/services/core/java/com/android/server/pm/Settings.java</a></p>
<p>Settings对象初始化时创建了一系列文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">428</span>    Settings(File dataDir, Object lock) &#123;</span><br><span class="line"><span class="number">429</span>        mLock = lock;</span><br><span class="line"><span class="number">430</span></span><br><span class="line"><span class="number">431</span>        mRuntimePermissionsPersistence = <span class="keyword">new</span> RuntimePermissionPersistence(mLock);</span><br><span class="line"><span class="number">432</span></span><br><span class="line"><span class="number">433</span>        mSystemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);</span><br><span class="line"><span class="number">434</span>        mSystemDir.mkdirs();</span><br><span class="line"><span class="number">435</span>        FileUtils.setPermissions(mSystemDir.toString(),</span><br><span class="line"><span class="number">436</span>                FileUtils.S_IRWXU|FileUtils.S_IRWXG</span><br><span class="line"><span class="number">437</span>                |FileUtils.S_IROTH|FileUtils.S_IXOTH,</span><br><span class="line"><span class="number">438</span>                -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line"><span class="number">439</span>        mSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages.xml"</span>);</span><br><span class="line"><span class="number">440</span>        mBackupSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-backup.xml"</span>);</span><br><span class="line"><span class="number">441</span>        mPackageListFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages.list"</span>);</span><br><span class="line"><span class="number">442</span>        FileUtils.setPermissions(mPackageListFilename, <span class="number">0640</span>, SYSTEM_UID, PACKAGE_INFO_GID);</span><br><span class="line"><span class="number">443</span></span><br><span class="line"><span class="number">444</span>        <span class="keyword">final</span> File kernelDir = <span class="keyword">new</span> File(<span class="string">"/config/sdcardfs"</span>);</span><br><span class="line"><span class="number">445</span>        mKernelMappingFilename = kernelDir.exists() ? kernelDir : <span class="keyword">null</span>;</span><br><span class="line"><span class="number">446</span></span><br><span class="line"><span class="number">447</span>        <span class="comment">// Deprecated: Needed for migration</span></span><br><span class="line"><span class="number">448</span>        mStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-stopped.xml"</span>);</span><br><span class="line"><span class="number">449</span>        mBackupStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-stopped-backup.xml"</span>);</span><br><span class="line"><span class="number">450</span>    &#125;</span><br></pre></td></tr></table></figure>

<p><code>packages.xml</code>:存放系统中安装的所有应用的包名、前面、缓存目录、权限等信息</p>
<p><code>packages.list</code>:存放应用包名、uid、安装目录、gid等信息</p>
<p>接下来在PackageManagerService构造方法中，从SystemConfig中获取了权限配置，以及从SELinuxMMAC读物安装策略等。</p>
<p>然后，就该扫描系统中的apk文件了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">		<span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line"><span class="number">1870</span>        <span class="comment">// writer</span></span><br><span class="line"><span class="number">1871</span>        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">    ......</span><br><span class="line">        <span class="comment">// Collect vendor overlay packages.</span></span><br><span class="line"><span class="number">2063</span>            <span class="comment">// (Do this before scanning any apps.)</span></span><br><span class="line"><span class="number">2064</span>            <span class="comment">// For security and version matching reason, only consider</span></span><br><span class="line"><span class="number">2065</span>            <span class="comment">// overlay packages if they reside in VENDOR_OVERLAY_DIR.</span></span><br><span class="line"><span class="number">2066</span>            File vendorOverlayDir = <span class="keyword">new</span> File(VENDOR_OVERLAY_DIR);</span><br><span class="line"><span class="number">2067</span>            scanDirLI(vendorOverlayDir, PackageParser.PARSE_IS_SYSTEM</span><br><span class="line"><span class="number">2068</span>                    | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</span><br><span class="line"><span class="number">2069</span></span><br><span class="line"><span class="number">2070</span>            <span class="comment">// Find base frameworks (resource packages without code).</span></span><br><span class="line"><span class="number">2071</span>            scanDirLI(frameworkDir, PackageParser.PARSE_IS_SYSTEM</span><br><span class="line"><span class="number">2072</span>                    | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line"><span class="number">2073</span>                    | PackageParser.PARSE_IS_PRIVILEGED,</span><br><span class="line"><span class="number">2074</span>                    scanFlags | SCAN_NO_DEX, <span class="number">0</span>);</span><br><span class="line"><span class="number">2075</span></span><br><span class="line"><span class="number">2076</span>            <span class="comment">// Collected privileged system packages.</span></span><br><span class="line"><span class="number">2077</span>            <span class="keyword">final</span> File privilegedAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"priv-app"</span>);</span><br><span class="line"><span class="number">2078</span>            scanDirLI(privilegedAppDir, PackageParser.PARSE_IS_SYSTEM</span><br><span class="line"><span class="number">2079</span>                    | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line"><span class="number">2080</span>                    | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</span><br><span class="line"><span class="number">2081</span></span><br><span class="line"><span class="number">2082</span>            <span class="comment">// Collect ordinary system packages.</span></span><br><span class="line"><span class="number">2083</span>            <span class="keyword">final</span> File systemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</span><br><span class="line"><span class="number">2084</span>            scanDirLI(systemAppDir, PackageParser.PARSE_IS_SYSTEM</span><br><span class="line"><span class="number">2085</span>                    | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"><span class="number">2086</span></span><br><span class="line"><span class="number">2087</span>            <span class="comment">// Collect all vendor packages.</span></span><br><span class="line"><span class="number">2088</span>            File vendorAppDir = <span class="keyword">new</span> File(<span class="string">"/vendor/app"</span>);</span><br><span class="line"><span class="number">2089</span>            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">2090</span>                vendorAppDir = vendorAppDir.getCanonicalFile();</span><br><span class="line"><span class="number">2091</span>            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"><span class="number">2092</span>                <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line"><span class="number">2093</span>            &#125;</span><br><span class="line"><span class="number">2094</span>            scanDirLI(vendorAppDir, PackageParser.PARSE_IS_SYSTEM</span><br><span class="line"><span class="number">2095</span>                    | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"><span class="number">2096</span></span><br><span class="line"><span class="number">2097</span>            <span class="comment">// Collect all OEM packages.</span></span><br><span class="line"><span class="number">2098</span>            <span class="keyword">final</span> File oemAppDir = <span class="keyword">new</span> File(Environment.getOemDirectory(), <span class="string">"app"</span>);</span><br><span class="line"><span class="number">2099</span>            scanDirLI(oemAppDir, PackageParser.PARSE_IS_SYSTEM</span><br><span class="line"><span class="number">2100</span>                    | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"><span class="number">2101</span></span><br><span class="line"><span class="number">2102</span>            <span class="keyword">if</span> (DEBUG_UPGRADE) Log.v(TAG, <span class="string">"Running installd update commands"</span>);</span><br><span class="line"><span class="number">2103</span>            mInstaller.moveFiles();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入<code>scanDirLI</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5624</span>    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirLI</span><span class="params">(File dir, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line"><span class="number">5625</span>        <span class="keyword">final</span> File[] files = dir.listFiles();</span><br><span class="line"><span class="number">5626</span>        <span class="keyword">if</span> (ArrayUtils.isEmpty(files)) &#123;</span><br><span class="line"><span class="number">5627</span>            Log.d(TAG, <span class="string">"No files in app dir "</span> + dir);</span><br><span class="line"><span class="number">5628</span>            <span class="keyword">return</span>;</span><br><span class="line"><span class="number">5629</span>        &#125;</span><br><span class="line"><span class="number">5630</span></span><br><span class="line"><span class="number">5631</span>        <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line"><span class="number">5632</span>            Log.d(TAG, <span class="string">"Scanning app dir "</span> + dir + <span class="string">" scanFlags="</span> + scanFlags</span><br><span class="line"><span class="number">5633</span>                    + <span class="string">" flags=0x"</span> + Integer.toHexString(parseFlags));</span><br><span class="line"><span class="number">5634</span>        &#125;</span><br><span class="line"><span class="number">5635</span></span><br><span class="line"><span class="number">5636</span>        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line"><span class="number">5637</span>            <span class="keyword">final</span> <span class="keyword">boolean</span> isPackage = (isApkFile(file) || file.isDirectory())</span><br><span class="line"><span class="number">5638</span>                    &amp;&amp; !PackageInstallerService.isStageName(file.getName());</span><br><span class="line"><span class="number">5639</span>            <span class="keyword">if</span> (!isPackage) &#123;</span><br><span class="line"><span class="number">5640</span>                <span class="comment">// Ignore entries which are not packages</span></span><br><span class="line"><span class="number">5641</span>                <span class="keyword">continue</span>;</span><br><span class="line"><span class="number">5642</span>            &#125;</span><br><span class="line"><span class="number">5643</span>            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">5644</span>                scanPackageLI(file, parseFlags | PackageParser.PARSE_MUST_BE_APK,</span><br><span class="line"><span class="number">5645</span>                        scanFlags, currentTime, <span class="keyword">null</span>);</span><br><span class="line"><span class="number">5646</span>            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line"><span class="number">5647</span>                Slog.w(TAG, <span class="string">"Failed to parse "</span> + file + <span class="string">": "</span> + e.getMessage());</span><br><span class="line"><span class="number">5648</span></span><br><span class="line"><span class="number">5649</span>                <span class="comment">// Delete invalid userdata apps</span></span><br><span class="line"><span class="number">5650</span>                <span class="keyword">if</span> ((parseFlags &amp; PackageParser.PARSE_IS_SYSTEM) == <span class="number">0</span> &amp;&amp;</span><br><span class="line"><span class="number">5651</span>                        e.error == PackageManager.INSTALL_FAILED_INVALID_APK) &#123;</span><br><span class="line"><span class="number">5652</span>                    logCriticalInfo(Log.WARN, <span class="string">"Deleting invalid package at "</span> + file);</span><br><span class="line"><span class="number">5653</span>                    <span class="keyword">if</span> (file.isDirectory()) &#123;</span><br><span class="line"><span class="number">5654</span>                        mInstaller.rmPackageDir(file.getAbsolutePath());</span><br><span class="line"><span class="number">5655</span>                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">5656</span>                        file.delete();</span><br><span class="line"><span class="number">5657</span>                    &#125;</span><br><span class="line"><span class="number">5658</span>                &#125;</span><br><span class="line"><span class="number">5659</span>            &#125;</span><br><span class="line"><span class="number">5660</span>        &#125;</span><br><span class="line"><span class="number">5661</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到关键语句为：</p>
<p><code>scanPackageLI(file, parseFlags | PackageParser.PARSE_MUST_BE_APK,scanFlags, currentTime, null);</code></p>
<p>浏览并解析一个package:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5735</span>    <span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(File scanFile, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">5736</span>            <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    ......</span><br><span class="line"><span class="number">5739</span>        PackageParser pp = <span class="keyword">new</span> PackageParser();</span><br><span class="line">    ......</span><br><span class="line">        <span class="number">5749</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">5750</span>            pkg = pp.parsePackage(scanFile, parseFlags);</span><br><span class="line"><span class="number">5751</span>        &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line"><span class="number">5752</span>            <span class="keyword">throw</span> PackageManagerException.from(e);</span><br><span class="line"><span class="number">5753</span>        &#125;</span><br><span class="line">    ......</span><br><span class="line"><span class="number">5931</span>        <span class="comment">// Set application objects path explicitly.</span></span><br><span class="line"><span class="number">5932</span>        pkg.applicationInfo.volumeUuid = pkg.volumeUuid;</span><br><span class="line"><span class="number">5933</span>        pkg.applicationInfo.setCodePath(pkg.codePath);</span><br><span class="line"><span class="number">5934</span>        pkg.applicationInfo.setBaseCodePath(pkg.baseCodePath);</span><br><span class="line"><span class="number">5935</span>        pkg.applicationInfo.setSplitCodePaths(pkg.splitCodePaths);</span><br><span class="line"><span class="number">5936</span>        pkg.applicationInfo.setResourcePath(resourcePath);</span><br><span class="line"><span class="number">5937</span>        pkg.applicationInfo.setBaseResourcePath(baseResourcePath);</span><br><span class="line"><span class="number">5938</span>        pkg.applicationInfo.setSplitResourcePaths(pkg.splitCodePaths);</span><br><span class="line"><span class="number">5939</span></span><br><span class="line"><span class="number">5941</span>        PackageParser.Package scannedPkg = scanPackageLI(pkg, parseFlags, scanFlags</span><br><span class="line"><span class="number">5942</span>                | SCAN_UPDATE_SIGNATURE, currentTime, user);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先是解析APK包，进入<code>PackageParser.parsePackage()</code>:</p>
<p><a href="http://androidxref.com/6.0.1_r10/xref/frameworks/base/core/java/android/content/pm/PackageParser.java" target="_blank" rel="noopener">http://androidxref.com/6.0.1_r10/xref/frameworks/base/core/java/android/content/pm/PackageParser.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">752</span>    <span class="function"><span class="keyword">public</span> Package <span class="title">parsePackage</span><span class="params">(File packageFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line"><span class="number">753</span>        <span class="keyword">if</span> (packageFile.isDirectory()) &#123;</span><br><span class="line"><span class="number">754</span>            <span class="keyword">return</span> parseClusterPackage(packageFile, flags);</span><br><span class="line"><span class="number">755</span>        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">756</span>            <span class="keyword">return</span> parseMonolithicPackage(packageFile, flags);</span><br><span class="line"><span class="number">757</span>        &#125;</span><br><span class="line"><span class="number">758</span>    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">826</span>    <span class="meta">@Deprecated</span></span><br><span class="line"><span class="number">827</span>    <span class="function"><span class="keyword">public</span> Package <span class="title">parseMonolithicPackage</span><span class="params">(File apkFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line"><span class="number">828</span>      ......</span><br><span class="line"><span class="number">836</span>        <span class="keyword">final</span> AssetManager assets = <span class="keyword">new</span> AssetManager();</span><br><span class="line"><span class="number">837</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">838</span>            <span class="keyword">final</span> Package pkg = parseBaseApk(apkFile, assets, flags);</span><br><span class="line"><span class="number">839</span>            pkg.codePath = apkFile.getAbsolutePath();</span><br><span class="line"><span class="number">840</span>            <span class="keyword">return</span> pkg;</span><br><span class="line"><span class="number">841</span>        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">842</span>            IoUtils.closeQuietly(assets);</span><br><span class="line"><span class="number">843</span>        &#125;</span><br><span class="line"><span class="number">844</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>进入<code>parseBaseApk</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">879</span>        <span class="keyword">final</span> <span class="keyword">int</span> cookie = loadApkIntoAssetManager(assets, apkPath, flags);</span><br><span class="line"><span class="number">880</span></span><br><span class="line"><span class="number">881</span>        Resources res = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">882</span>        XmlResourceParser parser = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">883</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">884</span>            res = <span class="keyword">new</span> Resources(assets, mMetrics, <span class="keyword">null</span>);</span><br><span class="line"><span class="number">885</span>            assets.setConfiguration(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line"><span class="number">886</span>                    Build.VERSION.RESOURCES_SDK_INT);</span><br><span class="line"><span class="number">887</span>            parser = assets.openXmlResourceParser(cookie, ANDROID_MANIFEST_FILENAME);</span><br><span class="line"><span class="number">888</span></span><br><span class="line"><span class="number">889</span>            <span class="keyword">final</span> String[] outError = <span class="keyword">new</span> String[<span class="number">1</span>];</span><br><span class="line"><span class="number">890</span>            <span class="keyword">final</span> Package pkg = parseBaseApk(res, parser, flags, outError);</span><br><span class="line"><span class="number">891</span>            <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">892</span>                <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(mParseError,</span><br><span class="line"><span class="number">893</span>                        apkPath + <span class="string">" (at "</span> + parser.getPositionDescription() + <span class="string">"): "</span> + outError[<span class="number">0</span>]);</span><br><span class="line"><span class="number">894</span>            &#125;</span><br><span class="line"><span class="number">895</span></span><br><span class="line"><span class="number">896</span>            pkg.volumeUuid = volumeUuid;</span><br><span class="line"><span class="number">897</span>            pkg.applicationInfo.volumeUuid = volumeUuid;</span><br><span class="line"><span class="number">898</span>            pkg.baseCodePath = apkPath;</span><br><span class="line"><span class="number">899</span>            pkg.mSignatures = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">900</span></span><br><span class="line"><span class="number">901</span>            <span class="keyword">return</span> pkg;</span><br></pre></td></tr></table></figure>

<p>可以看到又调用了一个<code>parseBaseApk</code>方法，但是参数变了，功能是解析Manifest:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1348</span>    <span class="comment">/**</span></span><br><span class="line"><span class="comment">1349     * Parse the manifest of a &lt;em&gt;base APK&lt;/em&gt;.</span></span><br><span class="line"><span class="comment">1350     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">1351     * When adding new features, carefully consider if they should also be</span></span><br><span class="line"><span class="comment">1352     * supported by split APKs.</span></span><br><span class="line"><span class="comment">1353     */</span></span><br><span class="line"><span class="number">1354</span>    <span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApk</span><span class="params">(Resources res, XmlResourceParser parser, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">1355</span>            String[] outError)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">	......</span><br><span class="line"><span class="number">1358</span>        AttributeSet attrs = parser;</span><br><span class="line">    ......</span><br><span class="line">        Pair&lt;String, String&gt; packageSplit = parsePackageSplitNames(parser, attrs, flags);</span><br><span class="line"><span class="number">1369</span>            pkgName = packageSplit.first;</span><br><span class="line"><span class="number">1370</span>            splitName = packageSplit.second;</span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line"><span class="number">1442</span>                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            .......</span><br><span class="line">                <span class="keyword">if</span> (tagName.equals(<span class="string">"application"</span>)) &#123;</span><br><span class="line">                    ......</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"overlay"</span>)) &#123;</span><br><span class="line">                    ......</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"permission-group"</span>)) &#123;</span><br><span class="line">                    ......</span><br><span class="line">                &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析完apk包，调用了<code>PackageParser.Package scannedPkg = scanPackageLI(pkg, parseFlags, scanFlags | SCAN_UPDATE_SIGNATURE, currentTime, user);</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">6466</span>    <span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> parseFlags,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">6467</span>            <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line"><span class="number">6468</span>        <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">6469</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">6470</span>            <span class="keyword">final</span> PackageParser.Package res = scanPackageDirtyLI(pkg, parseFlags, scanFlags,</span><br><span class="line"><span class="number">6471</span>                    currentTime, user);</span><br><span class="line"><span class="number">6472</span>            success = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">6473</span>            <span class="keyword">return</span> res;</span><br><span class="line"><span class="number">6474</span>        &#125;</span><br><span class="line">    ......</span><br><span class="line"><span class="number">6479</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>进入<code>scanPackageDirtyLI</code>,给app分配uid过程就在其中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">6481</span>    <span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageDirtyLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> parseFlags,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">6482</span>            <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    ......</span><br><span class="line"><span class="number">6591</span>        SharedUserSetting suid = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">6592</span>        PackageSetting pkgSetting = <span class="keyword">null</span>;</span><br><span class="line">    ......</span><br><span class="line"><span class="number">6672</span>            <span class="comment">// Just create the setting, don't add it yet. For already existing packages</span></span><br><span class="line"><span class="number">6673</span>            <span class="comment">// the PkgSetting exists already and doesn't have to be created.</span></span><br><span class="line"><span class="number">6674</span>            pkgSetting = mSettings.getPackageLPw(pkg, origPackage, realName, suid, destCodeFile,</span><br><span class="line"><span class="number">6675</span>                    destResourceFile, pkg.applicationInfo.nativeLibraryRootDir,</span><br><span class="line"><span class="number">6676</span>                    pkg.applicationInfo.primaryCpuAbi,</span><br><span class="line"><span class="number">6677</span>                    pkg.applicationInfo.secondaryCpuAbi,</span><br><span class="line"><span class="number">6678</span>                    pkg.applicationInfo.flags, pkg.applicationInfo.privateFlags,</span><br><span class="line"><span class="number">6679</span>                    user, <span class="keyword">false</span>);</span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>app包解析完，配置都获取到之后，就该写文件了，回到<code>PackageManagerService</code>构造方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2288</span>            updatePermissionsLPw(<span class="keyword">null</span>, <span class="keyword">null</span>, StorageManager.UUID_PRIVATE_INTERNAL, updateFlags);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">8244</span>    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updatePermissionsLPw</span><span class="params">(String changingPkg, PackageParser.Package pkgInfo,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">8245</span>            <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line"><span class="number">8246</span>        <span class="keyword">final</span> String volumeUuid = (pkgInfo != <span class="keyword">null</span>) ? getVolumeUuidForPackage(pkgInfo) : <span class="keyword">null</span>;</span><br><span class="line"><span class="number">8247</span>        updatePermissionsLPw(changingPkg, pkgInfo, volumeUuid, flags);</span><br><span class="line"><span class="number">8248</span>    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">8250</span>    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updatePermissionsLPw</span><span class="params">(String changingPkg,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">8251</span>            PackageParser.Package pkgInfo, String replaceVolumeUuid, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="number">8315</span>        <span class="comment">// Now update the permissions for all packages, in particular</span></span><br><span class="line"><span class="number">8316</span>        <span class="comment">// replace the granted permissions of the system packages.</span></span><br><span class="line"><span class="number">8317</span>        <span class="keyword">if</span> ((flags&amp;UPDATE_PERMISSIONS_ALL) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">8318</span>            <span class="keyword">for</span> (PackageParser.Package pkg : mPackages.values()) &#123;</span><br><span class="line"><span class="number">8319</span>                <span class="keyword">if</span> (pkg != pkgInfo) &#123;</span><br><span class="line"><span class="number">8320</span>                    <span class="comment">// Only replace for packages on requested volume</span></span><br><span class="line"><span class="number">8321</span>                    <span class="keyword">final</span> String volumeUuid = getVolumeUuidForPackage(pkg);</span><br><span class="line"><span class="number">8322</span>                    <span class="keyword">final</span> <span class="keyword">boolean</span> replace = ((flags &amp; UPDATE_PERMISSIONS_REPLACE_ALL) != <span class="number">0</span>)</span><br><span class="line"><span class="number">8323</span>                            &amp;&amp; Objects.equals(replaceVolumeUuid, volumeUuid);</span><br><span class="line"><span class="number">8324</span>                    grantPermissionsLPw(pkg, replace, changingPkg);</span><br><span class="line"><span class="number">8325</span>                &#125;</span><br><span class="line"><span class="number">8326</span>            &#125;</span><br><span class="line"><span class="number">8327</span>        &#125;</span><br><span class="line"><span class="number">8328</span></span><br><span class="line"><span class="number">8329</span>        <span class="keyword">if</span> (pkgInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">8330</span>            <span class="comment">// Only replace for packages on requested volume</span></span><br><span class="line"><span class="number">8331</span>            <span class="keyword">final</span> String volumeUuid = getVolumeUuidForPackage(pkgInfo);</span><br><span class="line"><span class="number">8332</span>            <span class="keyword">final</span> <span class="keyword">boolean</span> replace = ((flags &amp; UPDATE_PERMISSIONS_REPLACE_PKG) != <span class="number">0</span>)</span><br><span class="line"><span class="number">8333</span>                    &amp;&amp; Objects.equals(replaceVolumeUuid, volumeUuid);</span><br><span class="line"><span class="number">8334</span>            grantPermissionsLPw(pkgInfo, replace, changingPkg);</span><br><span class="line"><span class="number">8335</span>        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>grantPermissionsLPw</code>, 经过一系列解析最终调用:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">8600</span>        <span class="keyword">for</span> (<span class="keyword">int</span> userId : changedRuntimePermissionUserIds) &#123;</span><br><span class="line"><span class="number">8601</span>            mSettings.writeRuntimePermissionsForUserLPr(userId, runtimePermissionsRevoked);</span><br><span class="line"><span class="number">8602</span>        &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5232</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeRuntimePermissionsForUserLPr</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">boolean</span> sync)</span> </span>&#123;</span><br><span class="line"><span class="number">5233</span>        <span class="keyword">if</span> (sync) &#123;</span><br><span class="line"><span class="number">5234</span>            mRuntimePermissionsPersistence.writePermissionsForUserSyncLPr(userId);</span><br><span class="line"><span class="number">5235</span>        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">5236</span>            mRuntimePermissionsPersistence.writePermissionsForUserAsyncLPr(userId);</span><br><span class="line"><span class="number">5237</span>        &#125;</span><br><span class="line"><span class="number">5238</span>    &#125;</span><br></pre></td></tr></table></figure>

<p>那么，修改app的uid的方法考虑两种方案：</p>
<p>（1）反射调用<code>writeRuntimePermissionsForUserLPr</code>,参数简单容易构造；</p>
<p>（2）修改最终写入的uid，packages.xml</p>
<p>目前还未实践出结果。</p>
<p>欲知后事如何，且听下回分解。</p>
<p><strong>引用文献：</strong></p>
<p>【1】<a href="https://blog.csdn.net/u014418171/article/details/103868878?ops_request_misc=%25257B%252522request%25255Fid%252522%25253A%252522160930023616780302911830%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fall.%252522%25257D&amp;request_id=160930023616780302911830&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-1-103868878.first_rank_v2_pc_rank_v29&amp;utm_term=Android%E5%AE%89%E5%85%A8%E4%B9%8B%E4%BD%BF%E7%94%A8root%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%A3%80%E6%B5%8B%E6%9C%BA%E5%88%B6,%E5%BC%BA%E8%A1%8C%E8%87%AA%E5%8A%A8%E5%85%81%E8%AE%B8%E5%BA%94%E7%94%A8%E7%9A%84%E6%82%AC%E6%B5%AE%E7%AA%97/%E5%BA%94%E7%94%A8%E5%90%8E%E5%8F%B0%E5%BC%B9%E5%87%BA%E7%95%8C%E9%9D%A2%E7%AD%89%E6%9D%83%E9%99%90" target="_blank" rel="noopener">https://blog.csdn.net/u014418171/article/details/103868878?ops_request_misc=%25257B%252522request%25255Fid%252522%25253A%252522160930023616780302911830%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fall.%252522%25257D&amp;request_id=160930023616780302911830&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-1-103868878.first_rank_v2_pc_rank_v29&amp;utm_term=Android%E5%AE%89%E5%85%A8%E4%B9%8B%E4%BD%BF%E7%94%A8root%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%A3%80%E6%B5%8B%E6%9C%BA%E5%88%B6,%E5%BC%BA%E8%A1%8C%E8%87%AA%E5%8A%A8%E5%85%81%E8%AE%B8%E5%BA%94%E7%94%A8%E7%9A%84%E6%82%AC%E6%B5%AE%E7%AA%97/%E5%BA%94%E7%94%A8%E5%90%8E%E5%8F%B0%E5%BC%B9%E5%87%BA%E7%95%8C%E9%9D%A2%E7%AD%89%E6%9D%83%E9%99%90</a></p>
<p>【2】<a href="https://blog.csdn.net/zhangyongfeiyong/article/details/52292347" target="_blank" rel="noopener">https://blog.csdn.net/zhangyongfeiyong/article/details/52292347</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/12/21/Android%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="next" title="Android应用权限控制源码分析">
                <i class="fa fa-chevron-left"></i> Android应用权限控制源码分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">clicker</p>
              <p class="site-description motion-element" itemprop="description">灾难总是接踵而至，这正是世间的常理。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#修改uid之getuid"><span class="nav-number">1.</span> <span class="nav-text">修改uid之getuid</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改uid之生成uid"><span class="nav-number">2.</span> <span class="nav-text">修改uid之生成uid</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">clicker</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
